---
title: "STA5092Z Assignment 2"
author: "Tino Muzambi"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries. If these are not already installed on your machine, uncomment the three lines to install the packages first.

```{r}
# install.packages(tidyverse)
# install.packages(plotly)
# install.packages(DT)
# install.packages(leaflet)
# install.packages(sf)
# install.packages("rnaturalearth")
# install.packages("rnaturalearthdata")
# install.packages("viridis")
library(tidyverse)
library(plotly)
library(DT)
library(leaflet)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(viridis)
```

# Load Data

```{r}
earthquakes <- read.csv("./data/Earthquakes 1965 - 2016.csv") %>% as_tibble()
query <- read.csv("./data/query.csv") %>% as_tibble()
```

# Check data

```{r}
str(earthquakes)
summary(earthquakes)

str(query)
summary(query)
```

# Rename variables to common standard. i.e lowercase and fullstop between words.

```{r}
earthquakes <- earthquakes %>% 
  rename(date = Date, time = Time, latitude = Latitude,
         longitude = Longitude, type = Type, depth = Depth,
         depth.error = Depth.Error, depth.stations = Depth.Seismic.Stations,
         magnitude = Magnitude, magnitude.type = Magnitude.Type,
         magnitude.error = Magnitude.Error, magnitude.stations = Magnitude.Seismic.Stations,
         azimuthal.gap = Azimuthal.Gap, distance = Horizontal.Distance,
         distance.error = Horizontal.Error, rms = Root.Mean.Square, id = ID, source = Source,
         location.source = Location.Source, magnitude.source = Magnitude.Source, status = Status)

str(earthquakes)
```


```{r}
query <- query %>% 
  rename(magnitude = mag, magnitude.type = magType, num.stations = nst,
         azimuthal.gap = gap, distance = dmin, source = net,
         distance.error = horizontalError, depth.error = depthError,
         magnitude.error = magError, magnitude.num.stations = magNst,
         location.source = locationSource, magnitude.source = magSource)

str(query)
```

# Deal with dates

```{r}
# Check class of query time variable
class(query$time)

# Parse query time variable.
query <- query %>% 
  mutate(time = ymd_hms(time))

# Recheck class of query time variable
class(query$time)

# Check class of earthquakes time variable
class(earthquakes$time)

# Split dataset into two tibbles for each datetime format and parse each format separately.
a <- earthquakes %>% 
  filter(grepl("Z", time)) %>% 
  mutate(time = ymd_hms(time))
b <- earthquakes %>% 
  filter(!grepl("Z", time)) %>% 
  mutate(time = mdy_hms(paste(date, time)))

# Join two tibbles back into one.
earthquakes <- bind_rows(a, b)

# Recheck class of earthquakes time variable
class(earthquakes$time)
```

# Find common variables from both datasets.

```{r}
earthquakes.vars <- earthquakes %>% colnames

query.vars <- query %>% colnames

common.vars <- intersect(earthquakes.vars, query.vars)
```

# Select variables to keep based on intersection.

```{r}
earthquakes.common <- earthquakes %>% 
  dplyr::select(all_of(common.vars))

query.common <- query %>% 
  dplyr::select(all_of(common.vars))
```


# Filter query to data after 30 December 2016 to avoid overlap.

```{r}
query.common <- query.common %>% 
  filter(time >= as.Date("2016-12-31"))
```

# Merge datasets

```{r}
quakes <- bind_rows(earthquakes.common, query.common)

# Convert records to common case.
quakes <- quakes %>% 
  mutate(type = tolower(type), source = toupper(source), location.source = toupper(location.source), magnitude.source = toupper(magnitude.source), magnitude.type = toupper(magnitude.type), status = tolower(status))
```


# Explore the range of magnitudes

```{r}
summary(quakes$magnitude)

# Plot histogram of magnitude frequencies
mags.hist <- quakes %>% 
  ggplot(aes(magnitude)) +
  geom_histogram()
mags.hist
```

# Extent of missing data

```{r}
# Get proportions of na data in all variables.
na_proportions <- colMeans(is.na(quakes))
na_proportions_df <- data.frame(Proportion_NA = na_proportions)
datatable(na_proportions_df)
```

# Extent of discrepancy in values

```{r}
# Check range of numeric values.
for (col in names(quakes)) {
 if (is.numeric(quakes[[col]])) {
   cat(col, " range: ", range(quakes[[col]], na.rm = T), "\n")
 }
}
```

# Summary of the types of events

```{r}
# Get mean magnitude, depth, distance and count of each type of event.
events.summary <- quakes %>% 
  group_by(type) %>% 
  summarise(mean.magnitude = mean(magnitude),
            mean.depth = mean(depth),
            mean.distance = mean(distance, na.rm = T),
            count = n())
events.summary

# Extract nuclear explosions for later.
nuclear.explosions <- quakes %>% 
  filter(type == "nuclear explosion")

# Filter to only earthquakes.
quakes <- quakes %>% 
  filter(type == "earthquake")
```

# Add a categorical variable “Scale”

```{r}
# Categorise earthquakes by magnitude. (https://en.wikipedia.org/wiki/Richter_scale#Richter_magnitudes)
quakes <- quakes %>%
  mutate(scale = case_when(
    magnitude >= 1 & magnitude <= 1.9 ~ "micro",
    magnitude >= 2 & magnitude <= 2.9 ~ "minor",
    magnitude >= 3 & magnitude <= 3.9 ~ "slight",
    magnitude >= 4 & magnitude <= 4.9 ~ "light",
    magnitude >= 5 & magnitude <= 5.9 ~ "moderate",
    magnitude >= 6 & magnitude <= 6.9 ~ "strong",
    magnitude >= 7 & magnitude <= 7.9 ~ "major",
    magnitude >= 8 & magnitude <= 8.9 ~ "great",
    magnitude >= 9 & magnitude <= 9.9 ~ "extreme",
  ))
```


# Distribution of features

```{r}
# Distribution of magnitudes.
ggplotly(mags.hist)

# Distribution of scales.
scale.bar <- quakes %>% 
  ggplot(aes(scale)) +
  geom_bar()
ggplotly(scale.bar)

# Distribution of distances.
distance.hist <- quakes %>% 
  ggplot(aes(distance)) +
  geom_histogram()
ggplotly(distance.hist)

# Distribution of source.
source.bar <- quakes %>% 
  ggplot(aes(source)) +
  geom_bar()
ggplotly(source.bar)

```

# The largest earthquakes

```{r}
# Get the three largest earthquakes by magnitude.
largest.quakes <- quakes %>% 
  arrange(desc(magnitude)) %>% 
  head(n = 3)
largest.quakes
```

# Relationship between depth and magnitude

```{r}
# Scatter plot of depth vs. adjusted magnitude
depth.mag.scatter <- quakes %>% 
  ggplot(aes(depth, 10^(magnitude - 5))) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", se = FALSE) +
  xlab("Depth (km)") +
  ylab("Adjusted Magnitude") +
  ggtitle("Depth vs. Adjusted Magnitude")
ggplotly(depth.mag.scatter)

# Scatter plot of depth vs. magnitude
depth.mag.scatter.log <- quakes %>% 
  ggplot(aes(depth, magnitude)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", se = FALSE) +
  xlab("Depth (km)") +
  ylab("Magnitude") +
  ggtitle("Depth vs. Magnitude")
ggplotly(depth.mag.scatter.log)
```

# One of the types of events that were removed: Nuclear explosions.

```{r}
nuclear.explosions

# Show nuclear explosion sites.
nuclear.explosions.map <-  leaflet(nuclear.explosions) %>% 
  addTiles() %>% 
  addMarkers(nuclear.explosions$longitude, nuclear.explosions$latitude, popup = paste(
      "Latitude:", round(nuclear.explosions$latitude, 2), "<br>",
      "Longitude:", round(nuclear.explosions$longitude, 2), "<br>",
      "Date/Time:", nuclear.explosions$time
    )) %>% 
  setView(lng = mean(nuclear.explosions$longitude), lat = mean(nuclear.explosions$latitude), zoom = 1)
nuclear.explosions.map
  
```

# How do the frequency of earthquakes in each category compare to estimated frequencies like those given here: https://en.wikipedia.org/wiki/Richter_scale#Richter_magnitudes?

```{r}
# Calculate total earthquakes per year
total.year <- quakes %>%
  group_by(year(time)) %>%
  summarise(total = n(), scale = scale)

num.years <- length(unique(year(quakes$time)))

# Calculate average frequency per scale
scale.avg.freq <- total.year %>% 
  group_by(scale) %>% 
  summarise(avg.per.year = n() / num.years)
scale.avg.freq
```

# Do we observe any patterns over time? Is this a definite function of time, or perhaps an artefact of the data?

```{r}
# Create tibble with magnitude, scale and decade.
mag.decade <- quakes %>% 
  dplyr::select(magnitude, time, scale) %>% 
  mutate(decade = floor_date(time, "10 years"))

# Time series plot of magnitude over time.
mag.time <- mag.decade %>% 
  ggplot(aes(x = time, y = magnitude, color = scale)) +
  geom_point(alpha = 0.5) +
  labs(x = "Date-Time", y = "Magnitude", title = "Magnitude over Time") +
  theme_minimal()
mag.time

# Time series plot of magnitude over time.
mag.decade.plot <- mag.decade %>% 
  ggplot(aes(x = decade, y = magnitude, color = scale)) +
  geom_point(alpha = 0.5) +
  labs(x = "Decade", y = "Magnitude", title = "Magnitude over Decades") +
  theme_minimal()
mag.decade.plot
```
# The global picture

```{r}
# Create sf object.
quakes.ll <- quakes %>% 
  st_as_sf(coords = c("latitude", "longitude"), crs = 4326)
```

# Plot map


```{r}
# Get base world map.
world_map <- ne_countries(scale = "medium", returnclass = "sf")

# Plot world map with earthquakes data.
quakes.map <- ggplot() +
  geom_sf(data = world_map, fill = "lightgray", color = "gray") +
  geom_sf(data = quakes.ll, aes(colour = magnitude), alpha = 0.7) +
  scale_colour_distiller(palette = "Reds") +
  coord_sf(crs = "+proj=moll") +
  labs(title = "Earthquakes by Magnitude", x = "Longitude", y = "Latitude")
quakes.map
```

